<html><head>
    <meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
    <title>JMockit: The Basics</title>

  </head><body>
<h1>JMockit: The Basics</h1>This is a guide to quickly getting started with JMockit.&nbsp;&nbsp; <br>
<h2>Motivating Example</h2>Consider unit testing the following code:<br>

<pre>public class Y2KChecker {
    public void check() throws Y2KException {
        Calendar calendar = Calendar.getInstance();

        calendar.set(2000, 1, 1);

        Date date = calendar.getTime();

        if (date.getTime() == System.currentTimeMillis()) {
            throw new Y2KException("Y2K Bug!");
        }
    }

    public static class Y2KException extends Exception {
        public Y2KException(String reason) {
            super(reason);
        }
    }
}<br><br></pre>Getting this code to throw the Y2KException is difficult 
without some sort of test double injection framework or dependency injection/inversion of control 
abstraction.&nbsp;&nbsp; To illustrate the latter, we could refactor the
 code into something along these lines:<br>
<pre>public class Y2KChecker {    <br>    public static class Clock {<br>        public long currentTimeMillis() {<br>            return System.currentTimeMillis();<br>        }<br>    }<br><br>    private final Clock clock;<br><br>    public Y2KChecker(Clock clock) {<br>        this.clock = clock;<br>    }<br><br>    public void check() throws Y2KException {
        Calendar calendar = Calendar.getInstance();

        calendar.set(2000, 1, 1);

        Date date = calendar.getTime();

        if (date.getTime() == clock.currentTimeMillis()) {
            throw new Y2KException("Y2K Bug!");
        }
    }

    public static class Y2KException extends Exception {
        public Y2KException(String reason) {
            super(reason);
        }
    }<br>}<br></pre>
This code is now more testable.&nbsp;&nbsp; To trigger the Y2KException, you could write a test case that looks like this:<br>
<pre>public class Test {<br><br>    @Test(expectedExceptions = Y2KChecker.Y2KException.class)<br>    public void testCheck() {<br>        Y2KChecker checker = new Y2KChecker(new Y2KChecker.Clock() {<br>            private static final long Y2K_MILLIS = 949433850262L;
<br>            public long currentTimeMillis() {<br>                return Y2K_MILLIS;<br>            }<br>        }<br><br>        checker.check();<br>    }<br>}<br><br></pre>
The problem with this approach, however, is that <em>implementational details of the class under test have to be exposed in its public API in order to test it</em>.&nbsp;&nbsp; This problem is shared with most dependency injection/inversion of control approaches to unit testing.<br>
<br>
Test double injection frameworks like JMockit introduce alternative mechanisms for 
replacing dependencies with test doubles without exposing 
implementational details of the class under test in its public API.<br>

<h2>Set Up JMockit with Maven and TestNG</h2>It's easy to setup JMockit with Maven and TestNG.&nbsp;&nbsp; In our example POM we...<br>
<ol>
  <li>Add a JMockit dependency and the JMockit Maven repository</li>
  <li>Add a TestNG dependency</li>
  <li>Add the Maven Surefire plugin to run our unit tests</li>
  <li>Add a testng.xml file where we will enumerate the test cases in our test suite</li>
  <li>Configure the Surefire plugin to run with the JMockit 
agent.&nbsp;&nbsp; The agent is responsible for injecting our test doubles at 
runtime.<br>
  </li>
</ol>

Minimal Maven POM:<br>
<pre>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd"&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

    &lt;groupId&gt;org.duderino.injection&lt;/groupId&gt;
    &lt;artifactId&gt;injection&lt;/artifactId&gt;
    &lt;name&gt;Injection&lt;/name&gt;
    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
    &lt;packaging&gt;jar&lt;/packaging&gt;
    &lt;url&gt;https://github.com/duderino/injection&lt;/url&gt;

    &lt;repositories&gt;
        &lt;repository&gt;
            &lt;id&gt;jmockit-svn&lt;/id&gt;
            &lt;url&gt;http://jmockit.googlecode.com/svn/maven-repo&lt;/url&gt;
            &lt;releases&gt;
                &lt;checksumPolicy&gt;ignore&lt;/checksumPolicy&gt;
            &lt;/releases&gt;
        &lt;/repository&gt;
    &lt;/repositories&gt;

    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;mockit&lt;/groupId&gt;
            &lt;artifactId&gt;jmockit&lt;/artifactId&gt;
            &lt;version&gt;0.999.10&lt;/version&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.testng&lt;/groupId&gt;
            &lt;artifactId&gt;testng&lt;/artifactId&gt;
            &lt;version&gt;6.1.1&lt;/version&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;

    &lt;build&gt;
        &lt;defaultGoal&gt;test&lt;/defaultGoal&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
                &lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt;
                &lt;version&gt;2.9&lt;/version&gt;
                &lt;configuration&gt;
                    &lt;useFile&gt;false&lt;/useFile&gt;
                    &lt;suiteXmlFiles&gt;
                        &lt;suiteXmlFile&gt;src/test/resources/org/duderino/injection/testng.xml&lt;/suiteXmlFile&gt;
                    &lt;/suiteXmlFiles&gt;<span class="nt"><br>                    &lt;argLine&gt;</span>-javaagent:"${settings.localRepository}"/mockit/jmockit/0.999.10/jmockit-0.999.10.jar<span class="nt">&lt;/argLine&gt;</span><br>                &lt;/configuration&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;
&lt;/project&gt;
<br></pre>

Providing you put your code and other resources in the <a href="http://maven.apache.org/guides/introduction/introduction-to-the-standard-directory-layout.html">standard directories</a>, Maven will take care of the rest.<br>
<br>
If you are running JDK 1.6+, you can omit the 
"&lt;argLine&gt;-javaagent..." line, but if you do so you'll see 
worrying warning messages like this:<br>
<pre>WARNING: JMockit was initialized on demand, which may cause certain tests to fail;
please check the documentation for better ways to get it initialized.
<br></pre>
As you add unit tests, add them to the testng.xml file.&nbsp;&nbsp; Our testng.xml file looks like this:<br>

<pre>&lt;!DOCTYPE suite SYSTEM "http://testng.org/testng-1.0.dtd" &gt;
&lt;suite name="Injection" verbose="1" parallel="false" thread-count="1"&gt;
    &lt;test name="unit"&gt;
        &lt;classes&gt;
            &lt;class name="org.duderino.injection.jmockit.basic.Y2KCheckerTest"/&gt;
        &lt;/classes&gt;
    &lt;/test&gt;
&lt;/suite&gt;<br></pre>
<h2>Create A Test Case</h2>Now that our development environment is setup, let's write a test case to test the Y2KChecker class.<br>
<br>
Y2KCheckerTest:<br>

<pre>import mockit.Mock;
import mockit.Mockit;
import org.testng.annotations.Test;

public class Y2KCheckerTest {
    private static class MockSystem {
        private static final long Y2K_MILLIS = 949433850262L;

        @Mock
        public long currentTimeMillis() {
            return Y2K_MILLIS;
        }
    }

    @Test(expectedExceptions = Y2KChecker.Y2KException.class)
    public void testCheck() throws Exception {
        Y2KChecker checker = new Y2KChecker();

        Mockit.setUpMock(System.class, MockSystem.class);

        checker.check();
    }
}
<br></pre>
The first thing to realize is that we didn't have to modify the 
Y2KChecker class in order to inject our test double.&nbsp;&nbsp; We 
didn't have to create a wrapper for System.currentTimeMillis() 
either.&nbsp;&nbsp; Instead we created a MockSystem test double with a 
replacement currentTimeMillis() method.&nbsp;&nbsp; Note the @Mock 
annotation on the replacement currentTimeMillis() method.<br>
<br>
Note also the Mockit.setupMock() call inside the test case.&nbsp;&nbsp; 
This call will reroute all calls to System to our 
MockSystem at runtime.&nbsp;&nbsp; When checker.check() is called,
 the JMockit agent will reroute the System.currentTimeMillis() call to 
MockSystem.currentTimeMillis();<br>
<h2>Run The Unit Tests</h2>Now let's run the test suite.&nbsp;&nbsp; Because we put this...<br>
<pre>&lt;build&gt;
    &lt;defaultGoal&gt;test&lt;/defaultGoal&gt;
    ...
&lt;/build&gt;<br></pre>... in our Maven POM, all we have to do is type 'mvn' in our top-level 
directory and Maven will run the test suite after completing all its 
prerequisites (e.g., compiling both the code under test and the test 
cases): <br>

<p>$ mvn<br>
[INFO] Scanning for projects...<br>
[INFO]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;


 <br>
[INFO] ------------------------------------------------------------------------<br>
[INFO] Building Injection 1.0-SNAPSHOT<br>
[INFO] ------------------------------------------------------------------------<br>
[INFO] <br>
[INFO] --- maven-resources-plugin:2.4.3:resources (default-resources) @ injection ---<br>
[WARNING] Using platform encoding (MacRoman actually) to copy filtered resources, i.e. build is platform dependent!<br>
[INFO] skip non existing resourceDirectory /Users/blattj/dev/injection/src/main/resources<br>
[INFO] <br>
[INFO] --- maven-compiler-plugin:2.3.2:compile (default-compile) @ injection ---<br>
[INFO] No sources to compile<br>
[INFO] <br>
[INFO] --- maven-resources-plugin:2.4.3:testResources (default-testResources) @ injection ---<br>
[WARNING] Using platform encoding (MacRoman actually) to copy filtered resources, i.e. build is platform dependent!<br>
[INFO] Copying 1 resource<br>
[INFO] <br>
[INFO] --- maven-compiler-plugin:2.3.2:testCompile (default-testCompile) @ injection ---<br>
[INFO] Nothing to compile - all classes are up to date<br>
[INFO] <br>
[INFO] --- maven-surefire-plugin:2.9:test (default-test) @ injection ---<br>
[INFO] Surefire report directory: /Users/blattj/dev/injection/target/surefire-reports<br>
  <br>
-------------------------------------------------------<br>
&nbsp;T E S T S<br>
-------------------------------------------------------<br>
Running TestSuite<br>
Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 0.798 sec<br>
  <br>
Results :<br>
  <br>
Tests run: 1, Failures: 0, Errors: 0, Skipped: 0<br>
  <br>
[INFO] ------------------------------------------------------------------------<br>
[INFO] BUILD SUCCESS<br>
[INFO] ------------------------------------------------------------------------<br>
[INFO] Total time: 3.205s<br>
[INFO] Finished at: Wed Nov 23 11:49:47 PST 2011<br>
[INFO] Final Memory: 4M/81M<br>
[INFO] ------------------------------------------------------------------------<br>
  </p>If this didn't work for you and you want to see a complete working example, our test code has been checked in at <a href="https://github.com/duderino/injection">https://github.com/duderino/injection</a>.&nbsp; 
<h2>Next Steps<br>
</h2>


If you want to keep going, see our <a href="JMockitEvaluation.html">JMockit Evaluation</a> for a more detailed overview.&nbsp;&nbsp; <br>
<br>
See also the <a href="http://jmockit.googlecode.com/svn/trunk/www/tutorial.html">JMockit tutorial</a> for official documentation.<br>
<h1>
  

</h1>
</body></html>