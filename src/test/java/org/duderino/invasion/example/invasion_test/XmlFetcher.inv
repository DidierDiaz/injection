package org.duderino.invasion.example.invasion_test;

import org.apache.http.HttpEntity;
import org.apache.http.HttpException;
import org.apache.http.HttpResponse;
import org.apache.http.HttpVersion;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.client.methods.HttpUriRequest;
import org.apache.http.entity.BasicHttpEntity;
import org.apache.http.impl.nio.client.DefaultHttpAsyncClient;
import org.apache.http.message.BasicHttpResponse;
import org.apache.http.nio.concurrent.FutureCallback;
import org.apache.http.nio.reactor.IOReactorException;
import org.w3c.dom.Document;
import org.w3c.dom.Node;
import org.w3c.dom.NodeList;

import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import java.io.ByteArrayInputStream;
import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.CancellationException;
import java.util.concurrent.CountDownLatch;
import java.util.concurrent.Future;

/**
 * A HTTP client that fetches and parses a XML response from n URLs concurrently and asynchronously.
 */
public class XmlFetcher {
    public XmlFetcher() {
    }

    public interface Callback {
        public void completed(Map<String, Object> results);
    }

    /**
     * GET and parse n XML responses from n URLs.
     *
     * @param URLs             The URLs to fetch
     * @param externalCallback A user-supplied callback that will be passed a map of URL to Object results.  Objects
     *                         can be downcast to either an org.w3c.dom.Document or a java.lang.Exception
     */
    public void fetch(final String[] URLs, final Callback externalCallback) {
        final Map<String, Object> results = new HashMap<String, Object>();
        final DefaultHttpAsyncClient client;

        try {
            client = [
                default: new DefaultHttpAsyncClient(),
                test1: new DefaultHttpAsyncClient() {
                    private static final String XML = "<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?><metadata xmlns=\"http://musicbrainz.org/ns/mmd-1.0#\" xmlns:ext=\"http://musicbrainz.org/ns/ext-1.0#\"><artist-list offset=\"0\" count=\"13\"><artist type=\"Person\" id=\"79239441-bfd5-4981-a70c-55c3f15c1287\" ext:score=\"100\"><name>Madonna</name><sort-name>Madonna</sort-name><life-span begin=\"1958-08-16\"/></artist></artist-list></metadata>";

                    @Override
                    public Future<HttpResponse> execute(HttpUriRequest request, FutureCallback<HttpResponse> callback) {
                        try {
                            BasicHttpResponse response = new BasicHttpResponse(HttpVersion.HTTP_1_1, 200, "OK");

                            BasicHttpEntity entity = new BasicHttpEntity();

                            byte[] content = XML.getBytes("UTF-8");

                            entity.setContentLength(content.length);
                            entity.setContentType("application/xml;charset=\"utf8\"");
                            entity.setContent(new ByteArrayInputStream(content));

                            response.setEntity(entity);

                            callback.completed(response);
                        } catch (Exception ex) {
                            callback.failed(ex);
                        }

                        return null;
                    }
                }
            ];
        } catch (IOReactorException ex) {
            for (String url : URLs) {
                results.put(url, ex);
            }

            return;
        }

        client.start();

        for (final String URL : URLs) {
            client.execute(new HttpGet(URL), new FutureCallback<HttpResponse>() {
                private String url = URL;

                public void completed(HttpResponse response) {
                    if (200 > response.getStatusLine().getStatusCode() || 300 <= response.getStatusLine().getStatusCode()) {
                        handleEvent(new HttpException(response.getStatusLine().getReasonPhrase()));

                        return;
                    }

                    HttpEntity body = response.getEntity();

                    try {
                        DocumentBuilder docBuilder = DocumentBuilderFactory.newInstance().newDocumentBuilder();

                        Document document = docBuilder.parse(body.getContent());

                        handleEvent(document);
                    } catch (Exception ex) {
                        handleEvent(ex);
                    }
                }

                public void failed(Exception ex) {
                    handleEvent(ex);
                }

                public void cancelled() {
                    handleEvent(new CancellationException());
                }

                private void handleEvent(Object object) {
                    boolean isComplete = false;

                    synchronized (results) {
                        results.put(url, object);

                        if (results.size() == URLs.length) {
                            isComplete = true;
                        }
                    }

                    if (isComplete) {
                        // TODO - do a client.shutdown() without a deadlock.
                        externalCallback.completed(results);
                    }
                }
            });
        }
    }

    /**
     * GET and parse n XML responses from n URLs
     *
     * @param URLs The URLs to fetch
     * @return A map of URL to Object results.  Objects can be downcast to either an org.w3c.dom.Document or a java.lang.Exception
     * @throws InterruptedException
     */
    public Map<String, Object> fetch(String[] URLs) throws InterruptedException {
        final CountDownLatch latch = new CountDownLatch(1);
        final Map<String, Object>[] result = (Map<String, Object>[]) new Map[1];

        fetch(URLs, new Callback() {
            @Override
            public void completed(Map<String, Object> results) {
                result[0] = results;
                latch.countDown();
            }
        });

        latch.await();

        return result[0];
    }

    test testValidResponseSync() {
        final String URL = "http://musicbrainz.org/ws/1/artist?limit=1&query=madonna";

        XmlFetcher client = new(test1) XmlFetcher();

        Map<String, Object> results = client.fetch(new String[]{URL});

        Object result = results.get("http://musicbrainz.org/ws/1/artist?limit=1&query=madonna");

        assert result instanceof Document;

        Document document = (Document) result;

        NodeList nodeList = document.getElementsByTagName("name");

        assert null != nodeList;
        assert 1 == nodeList.getLength();

        Node node = nodeList.item(0);

        assert "Madonna".equals(node.getTextContent());
    }

    test testValidResponseAsync() {
        final String URL = "http://musicbrainz.org/ws/1/artist?limit=1&query=madonna";

        XmlFetcher client = new(test1) XmlFetcher();

        client.fetch(new String[]{URL}, new XmlFetcher.Callback() {
            @Override
            public void completed(Map<String, Object> results) {
                Object result = results.get("http://musicbrainz.org/ws/1/artist?limit=1&query=madonna");

                assert result instanceof Document;

                Document document = (Document) result;

                NodeList nodeList = document.getElementsByTagName("name");

                assert null != nodeList;
                assert 1 == nodeList.getLength();

                Node node = nodeList.item(0);

                assert "Madonna".equals(node.getTextContent());
            }
        });
    }
}
